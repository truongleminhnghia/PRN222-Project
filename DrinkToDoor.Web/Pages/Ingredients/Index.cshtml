@page
@model DrinkToDoor.Web.Pages.Ingredients.Index
@using System.Globalization
@{
    ViewData["Title"] = "Danh sách nguyên liệu";
}

@section Styles {
    <style>
        .ingredient-card {
            transition: transform .2s, box-shadow .2s;
            cursor: pointer;
            border-radius: 1rem;
        }

        .ingredient-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, .15);
        }

        .card-thumb {
            object-fit: cover;
            width: 100%;
            height: 180px;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        .clamp-2 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
        }

        .clamp-1 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
        }
    </style>
}

<div class="container-xxl mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-transparent px-0">
            <li class="breadcrumb-item"><a href="/Index">Trang chủ</a></li>
            <li class="breadcrumb-item active" aria-current="page">Nguyên liệu</li>
        </ol>
    </nav>

    <!-- Filter Form -->
    <form method="get" class="row g-2 mb-4 align-items-end">
        <div class="col-md-4">
            <label class="form-label">Từ khóa</label>
            <input type="text" class="form-control" name="Keyword" value="@Model.Keyword"
                placeholder="Tìm theo tên, mô tả...">
        </div>

        <div class="col-md-3">
            <label class="form-label">Sắp xếp theo</label>
            <select class="form-select" name="SortBy">
                <option value="Name" selected="@(Model.SortBy == "Name" ? "selected" : null)">Tên A-Z</option>
                <option value="PriceAsc" selected="@(Model.SortBy == "PriceAsc" ? "selected" : null)">Giá tăng dần
                </option>
                <option value="PriceDesc" selected="@(Model.SortBy == "PriceDesc" ? "selected" : null)">Giá giảm dần
                </option>
            </select>
        </div>

        <div class="col-md-2 text-end">
            <button type="submit" class="btn btn-primary w-100">Lọc</button>
        </div>
    </form>

    <!-- Card View -->
    <div class="row gy-4" id="ingredientList">
        @foreach (var item in Model.Ingredients)
        {
            <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                <div class="card ingredient-card shadow-sm bg-white h-100"
                    onclick="location.href='@Url.Page("/Ingredients/Detail", new { id = item.Id })'">
                    <img src="@(item.Images?.FirstOrDefault()?.Url ?? Url.Content("~/images/placeholder.png"))"
                        class="card-img-top card-thumb" alt="@item.Name" />

                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title clamp-1 text-dark fw-bold">@item.Name</h5>
                        <p class="text-muted mb-1">@item.Price.ToString("C0", new CultureInfo("vi-VN"))</p>
                        <p class="card-text clamp-2 flex-grow-1">@item.Description</p>
                        <div class="d-flex gap-2 mt-3">
                            <a class="btn btn-primary flex-fill">Thêm giỏ hàng</a>
                            <a asp-page="Detail" asp-route-id="@item.Id" class="btn btn-outline-primary flex-fill">Xem chi
                                tiết</a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    <div class="card-footer bg-white mt-4">
        <nav aria-label="Trang" class="d-flex justify-content-center">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item @(Model.PageCurrent == 1 ? "disabled" : "")">
                    <a class="page-link" asp-route-PageCurrent="@(Model.PageCurrent - 1)"
                        asp-route-PageSize="@Model.PageSize">&lsaquo;</a>
                </li>
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.PageCurrent ? "active" : "")">
                        <a class="page-link" asp-route-PageCurrent="@i" asp-route-PageSize="@Model.PageSize">@i</a>
                    </li>
                }
                <li class="page-item @(Model.PageCurrent == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" asp-route-PageCurrent="@(Model.PageCurrent + 1)"
                        asp-route-PageSize="@Model.PageSize">&rsaquo;</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/ingredientHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveNewIngredient", function (ingredient) {
            const imageUrl = ingredient.imagePath || '/images/placeholder.png';
            const description = ingredient.description ?? '';

            const html = `
                    <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                        <div class="card ingredient-card shadow-sm bg-white h-100"
                            onclick="location.href='/Ingredients/Detail?id=${ingredient.id}'">
                            <img src="${imageUrl}"
                                 class="card-img-top card-thumb" alt="${ingredient.name}" />
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title clamp-1 text-dark fw-bold">${ingredient.name}</h5>
                                <p class="text-muted mb-1">${ingredient.price.toLocaleString('vi-VN')}₫</p>
                                <p class="card-text clamp-2 flex-grow-1">${description}</p>
                                <div class="d-flex gap-2 mt-3">
                                    <a class="btn btn-primary flex-fill">Thêm giỏ hàng</a>
                                    <a href="/Ingredients/Detail?id=${ingredient.id}" class="btn btn-outline-primary flex-fill">Xem chi tiết</a>
                                </div>
                            </div>
                        </div>
                    </div>`;

            const container = document.getElementById("ingredientList");
            if (container) {
                container.insertAdjacentHTML("afterbegin", html);
            }
        });

        connection.start()
            .then(() => console.log("✅ Connected to IngredientHub"))
            .catch(err => console.error("❌ SignalR connection failed:", err));
    </script>
}
